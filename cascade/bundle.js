!function(t){var i={};function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var n in t)e.d(s,n,function(i){return t[i]}.bind(null,n));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=0)}([function(t,i,e){"use strict";e.r(i);class s{constructor(t,i,e){this.ctx=t,this.width=i,this.height=e,this.actors=[],this.zIndex=0}init(){this.ox=canvas.getBoundingClientRect().left,this.oy=canvas.getBoundingClientRect().top,this.bindEvent()}getMsg(){return JSON.stringify(this.rectify())}verify(){}rectify(){let t=Math.min(...this.actors.map(t=>t.posX)),i=Math.min(...this.actors.map(t=>t.posY));return this.actors.map(e=>({index:e.index,posX:e.posX-t,posY:e.posY-i,id:e.id,rotateState:e.rotateState,flipState:e.flipState}))}load(t){this.actors=[],this.actors.push(...JSON.parse(t).map(t=>new r(this,{...t})))}bindEvent(){let t=0,i=0,e=this,n=s.CELL;window.onmousedown=function(s){t=s.clientX-e.ox,i=s.clientY-e.oy,e.press=!0},window.onmouseup=function(t){e.press=!1;let i=e.curr;i&&(i.posX=Math.round(i.x/n),i.posY=Math.round(i.y/n),i.x=i.posX*n,i.y=i.posY*n,i.zIndex=e.zIndex,e.zIndex++)},window.onmousemove=function(s){if(e.press){e.curr=e.active({x:t/n,y:i/n});let r=e.curr;if(r){let o=t-r.posX*n+e.ox,a=i-r.posY*n+e.oy;r.x=s.clientX-o,r.y=s.clientY-a}}}}update(){this.render()}render(){this.ctx.clearRect(0,0,this.width,this.height),this.actors.forEach(t=>t.update()),this.drawGrid()}drawGrid(){let t=s.CELL;this.ctx.fillStyle=s.COLOR_GRID,this.ctx.globalCompositeOperation="source-over",this.ctx.beginPath();for(let i=0,e=this.width/t;i<e;i++)for(let e=0,s=this.height/t;e<s;e++)this.ctx.arc(t*i,t*e,2,0,2*Math.PI,!1),this.ctx.closePath();this.ctx.fill()}active(t){let i=this.actors.sort((t,i)=>i.zIndex-t.zIndex);for(const e of i){if(this.pointInPoly(t,e))return e}return null}pointInPoly(t,i){let e=0,{posX:s,posY:n}=i,r=i.points;for(let i=0,o=r.length;i<o;i++){let a=r[i],h=r[(i+1)%o];a.x!==h.x&&(t.x<Math.min(a.x,h.x)+s||t.x>=Math.max(a.x,h.x)+s||(t.x-a.x-s)*(h.y-a.y)/(h.x-a.x)+a.y+n>t.y&&e++)}return e%2==1}}s.CELL=35,s.COLOR_GRID="#aaa",s.RATE=.5;var n=[{id:"tr22",points:[{x:0,y:0},{x:2,y:2},{x:0,y:2}],vareity:4,mirror:0},{id:"tr33",points:[{x:0,y:0},{x:3,y:3},{x:0,y:3}],vareity:4,mirror:0},{id:"t42",points:[{x:0,y:0},{x:2,y:2},{x:0,y:4}],vareity:4,mirror:0},{id:"t63",points:[{x:0,y:0},{x:3,y:3},{x:0,y:6}],vareity:4,mirror:0},{id:"r22",points:[{x:0,y:0},{x:2,y:0},{x:2,y:2},{x:0,y:2}],vareity:0,mirror:0},{id:"r33",points:[{x:0,y:0},{x:3,y:0},{x:3,y:3},{x:0,y:3}],vareity:0,mirror:0},{id:"r44",points:[{x:0,y:0},{x:4,y:0},{x:4,y:4},{x:0,y:4}],vareity:0,mirror:0},{id:"r42",points:[{x:0,y:0},{x:4,y:0},{x:4,y:2},{x:0,y:2}],vareity:1,mirror:0},{id:"r43",points:[{x:0,y:0},{x:4,y:0},{x:4,y:3},{x:0,y:3}],vareity:1,mirror:0},{id:"d44",points:[{x:2,y:0},{x:4,y:2},{x:2,y:4},{x:0,y:2}],vareity:0,mirror:0},{id:"p32",points:[{x:2,y:0},{x:5,y:0},{x:3,y:2},{x:0,y:2}],vareity:1,mirror:1}];class r{constructor(t,i){this.scene=t,this.posX=i.posX||0,this.posY=i.posY||0,this.x=i.x||0,this.y=i.y||0,this.index=i.index||0,this.rotateState=i.rotateState||0,this.flipState=i.flipState||0,this.init()}init(){return this.x=s.CELL*this.posX,this.y=s.CELL*this.posY,this.points=JSON.parse(JSON.stringify(n[this.index].points)),this.id=n[this.index].id,this.vareity=n[this.index].vareity,this.mirror=n[this.index].mirror,this.zIndex=0,this.state(),this}state(){this.rotateState&&Array(this.rotateState).fill(1).forEach(t=>this.trans()),this.flipState&&Array(this.flipState).fill(1).forEach(t=>this.mirror())}rotate(){this.vareity&&(this.trans(),this.rotateState=++this.rotateState%this.vareity)}flip(){this.mirror&&(this.mirror(),this.flipState=++this.flipState%this.vareity)}mirror(){console.log(this.points);let t=Math.max(...this.points.map(t=>t.x));this.points.forEach(i=>{i.x=-i.x+t})}trans(){let t=Math.max(...this.points.map(t=>t.y));this.points.forEach(i=>{[i.x,i.y]=[-i.y+t,i.x]})}update(){this.render()}render(){let{ctx:t}=this.scene;t.fillStyle="#000",t.globalCompositeOperation="xor",t.beginPath(),this.points.forEach((i,e)=>{let n=this.x+i.x*s.CELL,r=this.y+i.y*s.CELL;e?t.lineTo(n,r):t.moveTo(n,r)}),t.closePath(),t.fill()}}class o{constructor(){this.manager=[],this.init()}init(){this.update()}add(t){t.action=!1,this.manager.push(t)}static freeze(t){t.action=!1}static unfreeze(t){t.init(),t.action=!0}remove(t){for(let i=0;i<this.manager.length;i++)if(t===this.manager[i])return void this.splice(i,1)}update(){this.manager.forEach(t=>{t.action&&t.update()}),requestAnimationFrame(this.update.bind(this))}}let a=document.querySelector("#canvas").getContext("2d"),h=new s(a,500,400),l=new r(h,{posX:1,posY:2,index:0}),c=new r(h,{posX:1,posY:2,index:4}),d=new r(h,{posX:4,posY:4,index:3}),p=new r(h,{posX:6,posY:2,index:4}),x=new r(h,{posX:5,posY:5,index:2});h.actors.push(l,d,p,x,c);let u=new o;u.add(h),o.unfreeze(h);let y=new class extends s{constructor(...t){super(...t)}init(){super.init(),this.bindEvent(),this.index=0}prev(){this.index=--this.index<0?n.length-1:this.index,this.actors.forEach((t,i)=>{if(t===this.curr){let{posX:e,posY:s}=t;this.actors.splice(i,1,new r(this,{posX:e,posY:s,index:this.index})),this.curr=this.actors[i]}})}next(){this.index=++this.index%n.length,this.actors.forEach((t,i)=>{if(t===this.curr){let{posX:e,posY:s}=t;this.actors.splice(i,1,new r(this,{posX:e,posY:s,index:this.index})),this.curr=this.actors[i]}})}flip(){this.curr&&this.curr.flip()}rotate(){this.curr&&this.curr.rotate()}add(){this.actors.push(new r(this,{posX:3,posY:3,index:this.index}))}remove(){this.actors.forEach((t,i)=>{t===this.curr&&this.actors.splice(i,1)})}clear(){this.actors=[]}clone(){this.curr&&this.actors.push(new r(this,{posX:0,posY:0,index:this.curr.index}))}save(){alert(this.getMsg())}}(a,500,400);u.add(y);let f=new class{constructor(t){this.title=t.title,this.ctrl=t.ctrl,this.init()}add(t,i){let e=document.createElement("div");e.innerHTML=t,e.onclick=i,this.ctrlDOM.appendChild(e)}init(){let t=document.createDocumentFragment();this.paneDOM=document.createElement("div"),this.paneDOM.classList.add("pane"),this.titleDOM=document.createElement("div"),this.titleDOM.classList.add("title"),this.titleDOM.innerHTML=this.title,this.ctrlDOM=document.createElement("div"),this.ctrlDOM.classList.add("ctrl"),this.paneDOM.appendChild(this.titleDOM),this.paneDOM.appendChild(this.ctrlDOM),t.appendChild(this.paneDOM),body.appendChild(t),this.ctrl.forEach(t=>this.add(t.name,t.func)),this.bindEvent()}show(){this.paneDOM.style.display="block"}hidden(){this.paneDOM.style.display="none"}bindEvent(){this.paneEventHandler()}paneEventHandler(){this.titleDOM.onmousedown=t=>{this.titleDOM.flag=!0,this.paneDOM.ox=this.paneDOM.getBoundingClientRect().left,this.paneDOM.oy=this.paneDOM.getBoundingClientRect().top,this.paneDOM.sx=t.clientX-this.paneDOM.ox,this.paneDOM.sy=t.clientY-this.paneDOM.oy},document.addEventListener("mouseup",()=>{this.titleDOM.flag=!1}),document.addEventListener("mousemove",t=>{if(t.target===this.titleDOM&&this.titleDOM.flag){let i=this.paneDOM.sx,e=this.paneDOM.sy;this.paneDOM.style.left=t.clientX-i+"px",this.paneDOM.style.top=t.clientY-e+"px"}})}}({title:"操作面板",ctrl:[{name:"上一个",func:y.prev.bind(y)},{name:"下一个",func:y.next.bind(y)},{name:"添加",func:y.add.bind(y)},{name:"移除",func:y.remove.bind(y)},{name:"旋转",func:y.rotate.bind(y)},{name:"镜像",func:y.flip.bind(y)},{name:"克隆",func:y.clone.bind(y)},{name:"清空",func:y.clear.bind(y)},{name:"复制当前配置",func:y.save.bind(y)}]});f.hidden(),mode.onchange=()=>{"0"===mode.value?(o.freeze(h),o.unfreeze(y),f.show(),btn.style.display="none"):"1"===mode.value&&(o.freeze(y),o.unfreeze(h),f.hidden(),btn.style.display="inline")},btn.onclick=()=>{let t=prompt("粘贴配置文件");t&&h.load(t)}}]);